<!DOCTYPE html>
<!-- Based on Basically Basic Jekyll Theme 1.4.4 created by Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/jekyll-theme-basically-basic/blob/master/LICENSE -->
<html
  lang="{{ page.lang | default: site.lang | default: 'en-US' }}"
  class="no-js"
>
  {% include head.html %}

  <body
    class="layout--{{ page.layout | default: layout.layout }}{% if page.classes or layout.classes %}{{ page.classes | default: layout.classes | join: ' ' | prepend: ' ' }}{% endif %} {{ page.title | slugify }}"
  >
    {% include skip-links.html %}

    <h1>Preview Data from Sitemap</h1>
    <button onclick="displayPreviewData()">Fetch Data</button>
    <table>
      <thead>
        <tr>
          <th>URL</th>
          <th>Total Views</th>
          <th>Today's Views</th>
          <th>Weekly Views</th>
          <th>Monthly Views</th>
        </tr>
      </thead>
      <tbody id="data-table"></tbody>
    </table>

    <script>
      // Fetch the URLs from the sitemap
      async function fetchURLsFromSitemap(sitemapUrl) {
        try {
          let response = await fetch(sitemapUrl);
          let text = await response.text();
          let parser = new DOMParser();
          let xmlDoc = parser.parseFromString(text, "text/xml");

          let urls = Array.from(xmlDoc.querySelectorAll("url loc")).map(
            (node) => node.textContent
          );
          console.log("Fetched URLs:", urls); // Debug log
          return urls;
        } catch (error) {
          console.error("Error fetching URLs from sitemap:", error);
          return [];
        }
      }

      // Fetch preview data from the API for a specific URL
      async function fetchPreviewData(url) {
        try {
          const adjustedUrl = `https://hits.sh/api/urns/${urlurl?.replace(
            "https://",
            ""
          )}`;
          const response = await fetch(adjustedUrl, {
            method: "GET",
            headers: {
              Accept: "application/json, text/plain",
              "Accept-Encoding": "gzip, deflate, br, zstd",
              "Accept-Language": "en-US,en;q=0.9,ru;q=0.8",
              Connection: "keep-alive",
              Cookie:
                "_ga=GA1.1.1907545419.1740203103; _ga_H551WJTXWV=GS1.1.1740241968.6.1.1740242247.0.0.0",
              Host: "hits.sh",
              Referer:
                "https://hits.sh/vadimnastoyashchy.github.io/what-is-a-testing-piramide-in-simple-words",
              "Sec-Fetch-Dest": "empty",
              "Sec-Fetch-Mode": "cors",
              "Sec-Fetch-Site": "same-origin",
              "User-Agent":
                "Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1",
            },
          });
          const data = await response.json();
          console.log("API Response for URL:", url, data); // Debug log

          // Find today's views
          const today = new Date().toISOString().slice(0, 10); // "YYYY-MM-DD"
          const todayData = data.items.find(
            (d) => d.from <= today && today <= d.to
          );
          const todayViews = todayData
            ? todayData.data.find((d) => d.day === today).value
            : 0;

          return {
            url,
            totalViews: data.total,
            todayViews,
            weeklyViews: data.weekly,
            monthlyViews: data.monthly,
          };
        } catch (error) {
          console.error("Error fetching preview data for URL:", url, error);
          return {
            url,
            totalViews: 0,
            todayViews: 0,
            weeklyViews: 0,
            monthlyViews: 0,
          };
        }
      }

      // Fetch sitemap and preview data, then display in table
      async function displayPreviewData() {
        try {
          const sitemapUrl = "https://vadimnastoyashchy.github.io/sitemap.xml";
          const urls = await fetchURLsFromSitemap(sitemapUrl);
          const tableBody = document.getElementById("data-table");
          tableBody.innerHTML = ""; // Clear previous results

          for (let url of urls) {
            const previewData = await fetchPreviewData(url);
            console.log("Preview Data:", previewData); // Debug log

            let row = `<tr>
                                <td>${previewData.url}</td>
                                <td>${previewData.totalViews}</td>
                                <td>${previewData.todayViews}</td>
                                <td>${previewData.weeklyViews}</td>
                                <td>${previewData.monthlyViews}</td>
                            </tr>`;

            tableBody.innerHTML += row;
          }
        } catch (error) {
          console.error("Error displaying preview data:", error);
        }
      }

      displayPreviewData();
    </script>

    {% include back-to-top.html %} {% include footer.html %} {% include
    scripts.html %}
  </body>
</html>
